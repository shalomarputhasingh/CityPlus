{% extends 'base.html' %}
{% load static %}

{% block title %}Verification Queue - Admin Portal{% endblock %}

{% block extra_css %}
<style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    .top-bar { background:#4b3dbb; color:#fff; padding:16px 30px; display:flex; justify-content:space-between; align-items:center; }
    .main { padding:30px; background:#f4f6f9; min-height: 90vh; }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title { color: #333; font-size: 24px; font-weight: 700; border-left: 5px solid #f1c40f; padding-left: 15px; }

    .issue-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border-left: 5px solid #f1c40f;
    }
    
    .card-header {
        padding: 15px 20px;
        background: #fffdf5;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-body { padding: 20px; display: flex; gap: 20px; }
    .card-content { flex: 1; }
    .card-image { width: 150px; height: 150px; border-radius: 8px; object-fit: cover; background: #eee; }
    
    .card-actions {
        padding: 15px 20px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    .btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; border: none; text-decoration: none; display: inline-block; }
    .btn-verify { background: #2ecc71; color: #fff; }
    .btn-verify:hover { background: #27ae60; }
    
    .btn-reject { background: #e74c3c; color: #fff; }
    .btn-reject:hover { background: #c0392b; }
    
    .meta-row { display: flex; gap: 20px; margin-bottom: 10px; color: #666; font-size: 14px; }
    .meta-item { display: flex; align-items: center; gap: 5px; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 10px; width: 500px; position: relative; }
    .close { float: right; font-size: 24px; cursor: pointer; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    
</style>
{% endblock %}

{% block content %}
<div class="top-bar">
  <h3>Admin Portal</h3>
  <div>
      <a href="{% url 'admin_dashboard' %}" style="color:white; margin-right:15px;">Dashboard</a>
      <a href="{% url 'logout' %}" style="color:white;">Logout</a>
  </div>
</div>

<div class="main">
    <div class="page-header">
        <h2 class="page-title">Verification Queue</h2>
        <span style="background: #f1c40f; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #555;">{{ issues.count }} Pending</span>
    </div>

    {% for issue in issues %}
    <div class="issue-card">
        <div class="card-header">
            <span style="font-weight: bold; font-size: 16px;">Issue #{{ issue.id }}: {{ issue.title }}</span>
            <span style="color: #666; font-size: 13px;">Submitted: {{ issue.created_at|date:"M d, Y H:i" }}</span>
        </div>
        
        <div class="card-body">
            {% if issue.image_url %}
                <a href="{{ issue.image_url }}" target="_blank">
                    <img src="{{ issue.image_url }}" class="card-image" alt="Issue Image">
                </a>
            {% else %}
                <div class="card-image" style="display:flex; align-items:center; justify-content:center; color:#999; font-size:12px;">No Image</div>
            {% endif %}
            
            <div class="card-content">
                <div class="meta-row">
                    <span class="meta-item"><strong>Category:</strong> {{ issue.category }}</span>
                    <span class="meta-item"><strong>Citizen:</strong> {{ issue.citizen.username }} ({{ issue.citizen.phone_number|default:'No Phone' }})</span>
                </div>
                <div class="meta-row">
                     <span class="meta-item"><strong>Location:</strong> {{ issue.address|default:issue.village }}</span>
                </div>
                <p style="margin-top: 10px; line-height: 1.5; color: #444;">{{ issue.description }}</p>
            </div>
        </div>
        
        <div class="card-actions">
            <button onclick="openRejectModal('{{ issue.id }}')" class="btn btn-reject">✗ Reject</button>
            <form action="{% url 'verify_issue' issue.id %}" method="POST" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-verify" onclick="return confirm('Verify this issue and move to resolution queue?')">✓ Verify</button>
            </form>
        </div>
    </div>
    {% empty %}
        <div style="text-align: center; padding: 50px; color: #888;">
            <h3>All caught up!</h3>
            <p>No unverified issues in the queue.</p>
        </div>
    {% endfor %}
</div>

<!-- Rejection Modal -->
<div id="rejectModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeRejectModal()">&times;</span>
        <h3 style="margin-bottom: 20px; color: #e74c3c;">Reject Issue</h3>
        <form id="rejectForm" method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label>Reason for Rejection</label>
                <select class="form-control" style="margin-bottom: 10px;" onchange="updateReason(this)">
                    <option value="">-- Select Reason --</option>
                    <option value="Duplicate submission">Duplicate submission</option>
                    <option value="Insufficient information">Insufficient information</option>
                    <option value="Out of jurisdiction">Out of jurisdiction</option>
                    <option value="Not a valid issue">Not a valid issue</option>
                    <option value="Other">Other</option>
                </select>
                <textarea name="rejection_reason" id="reasonText" class="form-control" rows="4" placeholder="Provide specific reason..." required></textarea>
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn" style="background: #ccc;" onclick="closeRejectModal()">Cancel</button>
                <button type="submit" class="btn btn-reject">Confirm Rejection</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openRejectModal(id) {
        document.getElementById('rejectForm').action = "/portal/reject/" + id + "/";
        document.getElementById('rejectModal').style.display = "block";
    }
    
    function closeRejectModal() {
        document.getElementById('rejectModal').style.display = "none";
    }
    
    function updateReason(select) {
        if(select.value !== 'Other' && select.value !== '') {
            document.getElementById('reasonText').value = select.value;
        } else if (select.value === '') {
            document.getElementById('reasonText').value = '';
        }
    }
    
    window.onclick = function(event) {
        if (event.target == document.getElementById('rejectModal')) {
            closeRejectModal();
        }
    }
</script>

{% endblock %}
